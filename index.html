<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom QR Code Generator</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Style for the canvas container to center the QR code */
        #qrPlaceholder {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            min-height: 300px;
        }
        /* Style the actual canvas generated by qrcode.js */
        #qrCanvas > canvas {
            border-radius: 0.75rem; /* Rounded corners for the entire canvas */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- Load qrcode.js Library for custom styling and rounded modules --><script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 rotatext-center">
            <span class="text-indigo-600">Custom</span> Branded QR Code
        </h1>
        <p class="text-center text-gray-500 mb-8">Generate a custom QR code with rounded modules and an embedded logo.</p>

        <!-- Input Fields --><div class="space-y-6">
            <div>
                <label for="urlInput" class="block text-sm font-medium text-gray-700">Link to Encode (URL)</label>
                <input type="url" id="urlInput" value="https://www.google.com/"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                       placeholder="e.g., https://yourwebsite.com">
            </div>
            <div>
                <label for="logoFileInput" class="block text-sm font-medium text-gray-700">Upload Center Logo Image (PNG/JPG)</label>
                <!-- Styled File Input --><input type="file" id="logoFileInput" accept="image/png, image/jpeg"
                       class="mt-1 block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150">
                <p class="mt-1 text-xs text-gray-500">Note: The design uses rounded dots and high error correction (H) for better aesthetics and stability.</p>
            </div>
        </div>

        <!-- Action Button --><button id="generateBtn" onclick="generateCustomQRCode()"
                class="w-full mt-8 py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01]">
            Generate Custom QR Code
        </button>

        <!-- Status Message & Loader --><p id="message" class="mt-4 text-center text-sm font-medium text-red-500 hidden"></p>

        <!-- QR Code Output Area --><div id="qrPlaceholder" class="flex-col">
            <!-- This div is where qrcode.js will put the canvas --><div id="qrCanvas"></div> 
            <a id="downloadLink" download="custom-qrcode.png"
               class="hidden mt-6 py-2 px-6 border border-transparent rounded-lg text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                Download QR Code (PNG)
            </a>
        </div>

    </div>

    <script>
        const MESSAGE = document.getElementById('message');
        const QR_CANVAS_CONTAINER = document.getElementById('qrCanvas');
        const DOWNLOAD_LINK = document.getElementById('downloadLink');
        const LOGO_FILE_INPUT = document.getElementById('logoFileInput');
        
        let logoBase64 = null; 
        const CANVAS_SIZE = 512;
        
        // Final, working GitHub RAW URL for the fallback logo.
        const FALLBACK_LOGO_URL = 'https://raw.githubusercontent.com/ndanchol/qr_gen_withimage/main/assets/default_logo.png'; 
        
        // --- File Upload Handler ---

        LOGO_FILE_INPUT.addEventListener('change', handleLogoUpload);

        /**
         * Reads the uploaded image file and converts it into a Base64 Data URL.
         */
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showMessage("Please upload a valid image file (PNG/JPG).", 'text-red-500');
                    logoBase64 = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    logoBase64 = e.target.result;
                    showMessage("Logo image loaded successfully. Click Generate.", 'text-green-600');
                };
                reader.onerror = () => {
                    showMessage("Error reading file.", 'text-red-500');
                    logoBase64 = null;
                };
                reader.readAsDataURL(file);
            } else {
                logoBase64 = null;
            }
        }

        // --- Custom QR Code Generation Logic ---

        function generateCustomQRCode() {
            MESSAGE.classList.add('hidden');
            DOWNLOAD_LINK.classList.add('hidden');

            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showMessage("Please enter a link to encode.");
                return;
            }

            // Clear previous QR code
            QR_CANVAS_CONTAINER.innerHTML = '';
            showMessage("Generating QR Code...", 'text-blue-600');

            // 1. Generate the custom QR code using qrcode.js
            try {
                // Initialize QRCode.js
                const qr = new QRCode(QR_CANVAS_CONTAINER, {
                    text: url,
                    width: CANVAS_SIZE,
                    height: CANVAS_SIZE,
                    colorDark: "#00274C", // Deep navy blue foreground color
                    colorLight: "#ffffff", // White background
                    correctLevel: QRCode.CorrectLevel.H // High error correction
                });

                // qrcode.js generates a canvas within the container. 
                // We need to wait a moment for it to render before drawing the logo.
                setTimeout(() => {
                    const qrCanvas = QR_CANVAS_CONTAINER.querySelector('canvas');
                    if (qrCanvas) {
                        drawLogoOnCanvas(qrCanvas, url); // Pass the URL for filename generation
                    } else {
                        showMessage("Could not find the generated QR canvas.", 'text-red-500');
                    }
                }, 100); // Small delay to ensure canvas is ready

            } catch (error) {
                console.error("QR Code generation failed:", error);
                showMessage("An error occurred during QR code generation.");
            }
        }

        /**
         * Draws the logo onto the generated canvas.
         */
        function drawLogoOnCanvas(canvasElement, url) {
            const ctx = canvasElement.getContext('2d');
            const imageSource = logoBase64 || FALLBACK_LOGO_URL; // Use uploaded logo or fallback

            const img = new Image();
            // Set crossOrigin to 'anonymous' when loading from an external domain like GitHub raw content
            img.crossOrigin = "anonymous"; 

            img.onload = () => {
                try {
                    // Logo size calculation: 20% of the QR code canvas size
                    const logoSize = CANVAS_SIZE * 0.20; 
                    const x = (CANVAS_SIZE - logoSize) / 2;
                    const y = (CANVAS_SIZE - logoSize) / 2;

                    // A. Draw a rounded white background square for better logo visibility
                    const padding = 10;
                    const radius = 10; 
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.roundRect(x - padding, y - padding, logoSize + 2 * padding, logoSize + 2 * padding, radius);
                    ctx.fill();
                    
                    // B. Draw the logo image
                    ctx.drawImage(img, x, y, logoSize, logoSize);
                    
                    // C. Enable download link and ensure PNG format
                    // Sanitize the URL to create a clean filename
                    const cleanUrl = url.replace(/^(https?:\/\/)?(www\.)?/, '').replace(/[^a-zA-Z0-9]+/g, '-').slice(0, 30);
                    const filename = `${cleanUrl || 'branded-qrcode'}.png`;

                    DOWNLOAD_LINK.href = canvasElement.toDataURL('image/png'); // Ensures PNG output
                    DOWNLOAD_LINK.download = filename; // Sets the filename to end with .png
                    DOWNLOAD_LINK.classList.remove('hidden');
                    
                    if (!logoBase64) {
                        // Success message for using the GitHub-hosted fallback logo
                        showMessage("QR Code generated successfully with your GitHub-hosted default logo. Ready to download.", 'text-green-600');
                    } else {
                        showMessage("Custom QR Code generated successfully! Ready to download.", 'text-green-600');
                    }

                } catch (e) {
                    console.error("Error drawing logo on canvas:", e);
                    showMessage("A problem occurred while drawing the logo.", 'text-red-500');
                }
            };

            img.onerror = () => {
                // If the GitHub link fails for any reason (e.g., deleted file)
                showMessage(`Fatal Error: The GitHub-hosted default logo could not be loaded from ${FALLBACK_LOGO_URL}.`, 'text-red-500');
            };

            img.src = imageSource;
        }

        /**
         * Utility to display status messages.
         */
        function showMessage(text, className = 'text-red-500') {
            MESSAGE.textContent = text;
            MESSAGE.className = `mt-4 text-center text-sm font-medium ${className}`;
            MESSAGE.classList.remove('hidden');
        }

        // Initialize with a call to generate a default QR code on load
        window.onload = generateCustomQRCode;
    </script>
</body>
</html>
